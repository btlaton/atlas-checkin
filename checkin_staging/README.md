# Atlas Check-In — Staging Bundle

Upload this folder to a new GitHub repository and deploy on Render.

## Contents
- `Dockerfile` — container build for the service
- `.dockerignore` — keeps the image lean
- `src/checkin_app.py` — Flask app exposing `app`
- `src/templates/checkin/*.html` — kiosk/admin/member pages
- `src/static/checkin/*` — CSS/JS assets (uses CDN fallback for QR scanning/render)

## Build Progress (Sep 2025)
- Kiosk UI: Large circular neon scan button, front camera default, centered headers, bold stencil-style title.
- Scanner: Native BarcodeDetector with jsQR fallback; live preview; auto-stop on success.
- Camera controls: Defaults to rear camera; "Flip Camera" button toggles front/rear. Front camera frames are corrected (un-mirrored) before decoding.
- Success UX: Full-screen overlay with chime; shows first name; 5-second auto-dismiss.
- Manual Check-In: One-of Name or Phone; name-only attempts single-match lookup.
- Resend QR: One-of Email or Phone; HTML email with “Open My QR Code” button; fallback token.
- CSV Import: Preview (inserts/updates/reactivations/deactivate candidates) and import with optional deactivation.
- Admin: PIN login; recent check-ins; CSV import and search.
- SMTP: Configurable via env (SendGrid, SES, Gmail); staging verified with SendGrid.
- Health: `/healthz` endpoint for monitoring.

## Render Deployment
1) Create a new Web Service from this repo (Render detects `Dockerfile`).
2) Add a Persistent Disk:
   - Name: `data`, Mount: `/data`, Size: 1–2 GB
3) Environment Variables:
   - `CHECKIN_DB_PATH=/data/checkin.sqlite3`
   - `CHECKIN_SESSION_SECRET=<random-long-string>`
- `CHECKIN_DUP_WINDOW_MINUTES=5`
- First run only: `ENABLE_INIT_PIN=1`
- (Optional) SMTP: `SMTP_HOST`, `SMTP_PORT=587`, `SMTP_USER`, `SMTP_PASS`, `SMTP_FROM`
4) Deploy → Initialize PIN:
   - Visit: `https://<service>/admin/init_pin?pin=1234&name=Admin`
   - Remove `ENABLE_INIT_PIN` and redeploy
5) Verify:
   - `https://<service>/healthz` → ok
   - `https://<service>/admin/login` → login with PIN
- `https://<service>/kiosk` → kiosk page

## Next Steps to Productionize
- Reliability & Offline
  - jsQR fallback is now vendored locally at `src/static/checkin/jsqr.min.js` (placeholder). Replace with the real jsQR build to enable offline scanning fallback.
  - QR rendering is server-side; no client QR lib needed.
  - Add PWA manifest, icons, and no-sleep hints; document Guided Access setup.
    - Manifest added at `src/static/manifest.webmanifest`; icons are generated by `/icons/icon-192.png` and `/icons/icon-512.png`.
- Security & Abuse Controls
  - Add CSRF tokens for admin forms.
  - PIN lockout (basic cooldown optional) and PIN rotation UI.
  - Rate-limit `/api/qr/resend` and admin endpoints.
- Data & Integrations
  - Lock Mindbody CSV mapping to real headers; add import validation report.
  - Optional scheduled nightly sync job or Mindbody API integration.
  - Migrate to Supabase; add DB adapter to switch via env.
- Observability & Ops
  - Add Sentry; structure logs for imports/check-ins.
  - Backups: Nightly copy of `/data/checkin.sqlite3` to cloud storage until Supabase.
  - Render Blueprint (render.yaml) for one-click setup (service, disk, envs).
- Branding & UX
  - Embed final stencil font (`src/static/fonts/STENCIL.woff`) and confirm loading.
  - Polish spacing, larger section headers, confirm readability at kiosk distance.

## QR Scanning — RCA and Hardening Guidance
- RCA (recent regression): The scanner default was switched to the front camera (user-facing), and mirrored frames caused inconsistent decoding in some environments. We now default to the rear camera and un‑mirror front-camera frames when used.
- Hardening recommendations:
  - Default to rear camera for kiosk scanning; keep a visible Flip Camera control.
  - jsQR fallback: Vendor real jsQR and use it when BarcodeDetector yields no results for N frames.
  - Visuals: Ask users to maximize phone brightness, increase QR size (220–320px on screen), and hold at a slight angle to minimize glare.
  - Contrast: Prefer black QR on white background; avoid low‑contrast themes in member QR display.
  - Distance: Best at ~10–25 cm; too close causes blur, too far reduces resolution.
  - Lighting: Ensure ambient light on the QR; avoid direct reflections on the phone’s glass.
  - Performance: Keep preview at modest resolution to increase frame rate; iPad Safari benefits from smaller decode surfaces.
  - Mounting: If the kiosk is mounted and rear camera is practical, rear camera yields fewer glare issues.

## Stencil Font
If you have a stencil font file, place it at `src/static/fonts/STENCIL.woff`. The CSS includes an `@font-face` named `AtlasStencil` and will use it for the title if present.

## Notes
- iPad scanning uses native API if available, falls back to jsQR via CDN.
- Member QR page renders locally if `/static/checkin/qrcode.min.js` is present, otherwise uses an external QR image.
